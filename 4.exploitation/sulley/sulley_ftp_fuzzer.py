#!/usr/bin/env python
# sulley_ftp_fuzzer.py - The name says it all.
# v0.01 2016/08/14 -  Currently untested!
#
# Copyright (C); 2016 jnqpblc - jnqpblc at gmail
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option); any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import sys
if len(sys.argv) < 5:
    sys.exit('\nUsage: %s <ip|192.168.1.10> <port|21> <user|jdoe> <pass|letmein> <process|Savant.exe> <start-cmd|C:\\Savant\\Savant.exe>' % sys.argv[0])

target_ip = str(sys.argv[1])
dest_port = int(sys.argv[2])
procmon_target = str(sys.argv[1])
netmon_target = str('127.0.0.1')
ftp_user = str(sys.argv[3])
ftp_pass = str(sys.argv[4])
process_name = str(sys.argv[5])
start_command = str(sys.argv[6])

from sulley import *
import time

# https://en.wikipedia.org/wiki/List_of_HTTP_header_fields
s_initialize("USER")
s_static("USER")
s_delim(" ")
s_static(ftp_user)
s_static("\r\n")

s_initialize("PASS")
s_static("PASS")
s_delim(" ")
s_static(ftp_pass)
s_static("\r\n")

ftp_commands = "APPEND ASCII BELL BINARY BYE CD CLOSE DELETE DEBUG DIR GET GLOB HASH HELP LCD LITERAL LS MDELETE MDIR MGET MKDIR MLS MPUT OPEN PROMPT PUT QUOTE RECV RENAME RMDIR SEND STATUS TRACE TYPE VERBOSE"
for ftp_command in ftp_commands:
	s_initialize("FTP")
	s_static(ftp_command)
	s_delim(" ")
	s_string("AAAA")
	s_static("\r\n")

print "Mutations: " + str(s_num_mutations())

print "Press CTRL/C to cancel in ",
for i in range(3):
	print str(3 - i) + " ",
	sys.stdout.flush()
	time.sleep(1)

print "Instantiating session"
sess = sessions.session(session_filename="ftp.session", sleep_time=0.25)

print "Instantiating target"
target = sessions.target(target_ip, dest_port)
target.procmon = pedrpc.client(procmon_target, 26002)
target.netmon = pedrpc.client(netmon_target, 26001)

target.procmon_options =  {
	"proc_name" : process_name,
	"stop_commands" : ['wmic process where (name="' + process_name + '") delete"'],
	"start_commands" : [start_command],
}

def get_ftp_banner(sock):
    sock.recv(1024)

print "Adding target"
sess.pre_send = get_ftp_banner
sess.add_target(target)

# Fuzz, then authenticate
sess.connect(s_get("USER"))
sess.connect(s_get("USER"),s_get("PASS"))

# Use authenticated command
sess.connect(s_get("PASS"),s_get("FTP"))

print "Starting fuzzing now"
sess.fuzz()
