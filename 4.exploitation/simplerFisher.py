import smtplib
import sys, os, argparse
from email.MIMEMultipart import MIMEMultipart
from email.MIMEBase import MIMEBase
from email.MIMEText import MIMEText
from email.Utils import COMMASPACE, formatdate
from email import Encoders

def send_mail(smtp_server, smtp_port, ehlo_name, email_body_file, email_attachment_file, email_subject, send_from, show_from, send_to):

   timeout = 10

   msg = MIMEMultipart()
   msg['From'] = show_from
   #msg['From'] = '"' + show_from + '" <' + show_from + '>'
   msg['To'] = send_to
   msg['Date'] = formatdate(localtime=True)
   msg['Subject'] = email_subject

   fp = open(email_body_file, 'r')
   msg.attach(MIMEText(fp.read()))
   fp.close()

   part = MIMEBase('application', "octet-stream")
   part.set_payload(open(email_attachment_file, "rb").read())
   Encoders.encode_base64(part)
   part.add_header('Content-Disposition', 'attachment; filename="%s"' % os.path.basename(email_attachment_file))
   msg.attach(part)

   smtp = smtplib.SMTP(smtp_server, smtp_port, ehlo_name, timeout)
   smtp.sendmail(send_from, send_to, msg.as_string())
   smtp.close()


if __name__ == '__main__':

   parser = argparse.ArgumentParser()
   parser.add_argument('-s', '--server', action='store', dest='smtp_server', type=str, required=True, help='SMTP server address.')
   parser.add_argument('-p', '--port', action='store', dest='smtp_port', type=int, required=True, help='SMTP server port.')
   parser.add_argument('-e', '--ehlo', action='store', dest='ehlo_name', type=str, required=True, help='SMTP EHLO hostname.')
   parser.add_argument('-b', '--body', action='store', dest='email_body_file', type=str, required=True, help='Plain-text body payload file.')
   parser.add_argument('-a', '--attachment', action='store', dest='email_attachment_file', type=str, required=True, help='File to send as an attachment.')
   parser.add_argument('-j', '--subject', action='store', dest='email_subject', type=str, required=True, help='A brief summary of the topic of the message.')
   parser.add_argument('-f', '--sendfrom', action='store', dest='send_from', type=str, required=True, help='The email address to use as a sender.')
   parser.add_argument('-d', '--showfrom', action='store', dest='show_from', type=str, required=True, help='The email address or name displayed to the target.')
   parser.add_argument('-t', '--sendto', action='store', dest='send_to', type=str, required=True, help='The email address to use as the primary recipient.')

   args = parser.parse_args()

   send_mail(args.smtp_server, args.smtp_port, args.ehlo_name, args.email_body_file, args.email_attachment_file, args.email_subject, args.send_from, args.show_from, args.send_to)

